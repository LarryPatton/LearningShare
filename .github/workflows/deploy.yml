name: CI/CD - Build Check and Deploy

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main æˆ– master åˆ†æ”¯
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

jobs:
  # ä»»åŠ¡1ï¼šä»£ç æ£€æŸ¥å’Œæ„å»ºæµ‹è¯•
  build-check:
    name: ğŸ” ä»£ç æ£€æŸ¥å’Œæ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      # 4. TypeScript ç±»å‹æ£€æŸ¥
      - name: ğŸ” TypeScript Check
        run: npx tsc --noEmit
        continue-on-error: false
      
      # 5. ESLint ä»£ç æ£€æŸ¥
      - name: âœ¨ ESLint Check
        run: npm run lint
        continue-on-error: true
      
      # 6. æ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ Build Project
        run: npm run build
      
      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next
          retention-days: 7

  # ä»»åŠ¡2ï¼šéƒ¨ç½²åˆ° Vercelï¼ˆä»…åœ¨æ„å»ºæˆåŠŸåæ‰§è¡Œï¼‰
  deploy:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build-check  # ä¾èµ–äº build-check ä»»åŠ¡æˆåŠŸ
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      # 2. éƒ¨ç½²ä¿¡æ¯
      - name: ğŸ“¢ Deployment Info
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Vercel"
          echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
          echo "ğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
      
      # 3. Vercel è‡ªåŠ¨éƒ¨ç½²é€šçŸ¥
      - name: âœ… Vercel Auto-Deploy
        run: |
          echo "âœ¨ Vercel å°†è‡ªåŠ¨æ£€æµ‹åˆ°è¿™æ¬¡æ¨é€å¹¶å¼€å§‹éƒ¨ç½²"
          echo "ğŸ”— æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://vercel.com/dashboard"
          echo "â±ï¸  é€šå¸¸éœ€è¦ 1-3 åˆ†é’Ÿå®Œæˆéƒ¨ç½²"

  # ä»»åŠ¡3ï¼šéƒ¨ç½²çŠ¶æ€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  notify:
    name: ğŸ“¬ Deployment Notification
    runs-on: ubuntu-latest
    needs: [build-check, deploy]
    if: always()
    
    steps:
      - name: ğŸ“Š Summary
        run: |
          echo "========================================="
          echo "   CI/CD Pipeline Summary"
          echo "========================================="
          echo ""
          if [ "${{ needs.build-check.result }}" == "success" ]; then
            echo "âœ… ä»£ç æ£€æŸ¥å’Œæ„å»º: æˆåŠŸ"
          else
            echo "âŒ ä»£ç æ£€æŸ¥å’Œæ„å»º: å¤±è´¥"
          fi
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Vercel éƒ¨ç½²: å·²è§¦å‘"
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "â­ï¸  Vercel éƒ¨ç½²: è·³è¿‡ (éä¸»åˆ†æ”¯)"
          else
            echo "âŒ Vercel éƒ¨ç½²: å¤±è´¥"
          fi
          echo ""
          echo "========================================="
