# 数据库模型设计

## 1. 数据库选型

**主数据库**：MySQL 8.0+ / PostgreSQL 14+  
**字符集**：UTF8MB4（支持 Emoji 等多字节字符）  
**存储引擎**：InnoDB（支持事务、外键）

---

## 2. 数据库 ER 图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   users     │         │  articles   │         │ categories  │
│  (用户表)    │◄───────┤  (文章表)    │────────►│  (分类表)    │
└─────────────┘         └─────────────┘         └─────────────┘
       │                       │                        │
       │                       │                        │
       │                       │                        │
       ↓                       ↓                        ↓
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  comments   │         │article_tags │         │    tags     │
│  (评论表)    │         │(文章标签关联)│────────►│  (标签表)    │
└─────────────┘         └─────────────┘         └─────────────┘
       │
       │
       ↓
┌─────────────┐
│   replies   │
│  (回复表)    │
└─────────────┘
```

---

## 3. 核心数据表设计

### 3.1 用户表（users）

```sql
CREATE TABLE `users` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  `email` VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（加密存储）',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `bio` VARCHAR(500) DEFAULT NULL COMMENT '个人简介',
  `role` ENUM('admin', 'user', 'guest') DEFAULT 'user' COMMENT '角色',
  `status` ENUM('active', 'inactive', 'banned') DEFAULT 'active' COMMENT '账号状态',
  `email_verified` TINYINT(1) DEFAULT 0 COMMENT '邮箱是否验证',
  `last_login_at` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_email` (`email`),
  KEY `idx_username` (`username`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

**字段说明**：
- `role`: 区分普通用户和管理员
- `status`: 支持封禁功能
- `email_verified`: 邮箱验证状态
- `password`: 使用 bcrypt 加密存储

---

### 3.2 分类表（categories）

```sql
CREATE TABLE `categories` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` VARCHAR(50) NOT NULL UNIQUE COMMENT '分类名称',
  `slug` VARCHAR(50) NOT NULL UNIQUE COMMENT 'URL别名',
  `description` VARCHAR(500) DEFAULT NULL COMMENT '分类描述',
  `parent_id` INT UNSIGNED DEFAULT NULL COMMENT '父分类ID（支持多级分类）',
  `icon` VARCHAR(100) DEFAULT NULL COMMENT '分类图标',
  `sort_order` INT DEFAULT 0 COMMENT '排序权重',
  `article_count` INT DEFAULT 0 COMMENT '文章数量（冗余字段，提升查询效率）',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_slug` (`slug`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_sort_order` (`sort_order`),
  FOREIGN KEY (`parent_id`) REFERENCES `categories`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='分类表';
```

**字段说明**：
- `slug`: SEO 友好的 URL 标识
- `parent_id`: 支持多级分类（如：技术 > 前端 > React）
- `article_count`: 缓存字段，减少 JOIN 查询

---

### 3.3 标签表（tags）

```sql
CREATE TABLE `tags` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '标签ID',
  `name` VARCHAR(50) NOT NULL UNIQUE COMMENT '标签名称',
  `slug` VARCHAR(50) NOT NULL UNIQUE COMMENT 'URL别名',
  `color` VARCHAR(7) DEFAULT '#3B82F6' COMMENT '标签颜色（HEX）',
  `article_count` INT DEFAULT 0 COMMENT '文章数量',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_slug` (`slug`),
  KEY `idx_article_count` (`article_count`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='标签表';
```

**字段说明**：
- `color`: 前端显示时的标签颜色
- 标签与文章是多对多关系，需要中间表

---

### 3.4 文章表（articles）

```sql
CREATE TABLE `articles` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '文章ID',
  `title` VARCHAR(200) NOT NULL COMMENT '文章标题',
  `slug` VARCHAR(200) NOT NULL UNIQUE COMMENT 'URL别名',
  `summary` VARCHAR(500) DEFAULT NULL COMMENT '文章摘要',
  `content` LONGTEXT NOT NULL COMMENT '文章内容（HTML或Markdown）',
  `cover_image` VARCHAR(255) DEFAULT NULL COMMENT '封面图URL',
  `author_id` INT UNSIGNED NOT NULL COMMENT '作者ID',
  `category_id` INT UNSIGNED DEFAULT NULL COMMENT '分类ID',
  `status` ENUM('draft', 'published', 'hidden') DEFAULT 'draft' COMMENT '发布状态',
  `is_top` TINYINT(1) DEFAULT 0 COMMENT '是否置顶',
  `is_featured` TINYINT(1) DEFAULT 0 COMMENT '是否精选',
  `view_count` INT UNSIGNED DEFAULT 0 COMMENT '浏览次数',
  `like_count` INT UNSIGNED DEFAULT 0 COMMENT '点赞数',
  `comment_count` INT UNSIGNED DEFAULT 0 COMMENT '评论数',
  `published_at` DATETIME DEFAULT NULL COMMENT '发布时间',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_slug` (`slug`),
  KEY `idx_author_id` (`author_id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_status` (`status`),
  KEY `idx_published_at` (`published_at`),
  KEY `idx_is_top_published` (`is_top`, `published_at`),
  FULLTEXT KEY `ft_title_content` (`title`, `content`), -- 全文索引（搜索）
  FOREIGN KEY (`author_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`category_id`) REFERENCES `categories`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文章表';
```

**字段说明**：
- `status`: 草稿/已发布/隐藏
- `is_top`: 支持文章置顶
- `is_featured`: 精选文章（首页推荐）
- `view_count/like_count/comment_count`: 统计字段（可用 Redis 缓存实时更新）
- `slug`: 用于生成 SEO 友好的 URL（如：/article/how-to-learn-react）

---

### 3.5 文章标签关联表（article_tags）

```sql
CREATE TABLE `article_tags` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `article_id` INT UNSIGNED NOT NULL COMMENT '文章ID',
  `tag_id` INT UNSIGNED NOT NULL COMMENT '标签ID',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_article_tag` (`article_id`, `tag_id`),
  KEY `idx_tag_id` (`tag_id`),
  FOREIGN KEY (`article_id`) REFERENCES `articles`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`tag_id`) REFERENCES `tags`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文章标签关联表';
```

**字段说明**：
- 多对多关系中间表
- 唯一索引防止重复关联

---

### 3.6 评论表（comments）

```sql
CREATE TABLE `comments` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '评论ID',
  `article_id` INT UNSIGNED NOT NULL COMMENT '文章ID',
  `user_id` INT UNSIGNED NOT NULL COMMENT '评论用户ID',
  `content` TEXT NOT NULL COMMENT '评论内容',
  `parent_id` INT UNSIGNED DEFAULT NULL COMMENT '父评论ID（支持多级回复）',
  `root_id` INT UNSIGNED DEFAULT NULL COMMENT '根评论ID（方便查询评论树）',
  `like_count` INT UNSIGNED DEFAULT 0 COMMENT '点赞数',
  `status` ENUM('pending', 'approved', 'rejected') DEFAULT 'approved' COMMENT '审核状态',
  `ip_address` VARCHAR(45) DEFAULT NULL COMMENT 'IP地址',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_root_id` (`root_id`),
  KEY `idx_created_at` (`created_at`),
  FOREIGN KEY (`article_id`) REFERENCES `articles`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`parent_id`) REFERENCES `comments`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`root_id`) REFERENCES `comments`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论表';
```

**字段说明**：
- `parent_id`: 支持评论回复（如：A 评论文章，B 回复 A 的评论）
- `root_id`: 指向评论树的根节点，便于查询整个评论链
- `status`: 支持评论审核（防止垃圾评论）
- `ip_address`: 记录 IP，防止恶意刷评论

---

### 3.7 点赞记录表（likes）

```sql
CREATE TABLE `likes` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '点赞ID',
  `user_id` INT UNSIGNED NOT NULL COMMENT '用户ID',
  `target_type` ENUM('article', 'comment') NOT NULL COMMENT '点赞对象类型',
  `target_id` INT UNSIGNED NOT NULL COMMENT '点赞对象ID',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_target` (`user_id`, `target_type`, `target_id`),
  KEY `idx_target` (`target_type`, `target_id`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='点赞记录表';
```

**字段说明**：
- 统一管理文章和评论的点赞
- 唯一索引防止重复点赞
- 可扩展支持其他对象点赞（如：用户、话题等）

---

### 3.8 浏览历史表（view_history）

```sql
CREATE TABLE `view_history` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `user_id` INT UNSIGNED DEFAULT NULL COMMENT '用户ID（可为空，支持访客）',
  `article_id` INT UNSIGNED NOT NULL COMMENT '文章ID',
  `ip_address` VARCHAR(45) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` VARCHAR(255) DEFAULT NULL COMMENT '用户代理',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '浏览时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_created_at` (`created_at`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`article_id`) REFERENCES `articles`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='浏览历史表';
```

**字段说明**：
- 记录用户浏览行为（用于个性化推荐）
- `user_id` 可为空，支持未登录访客统计
- 可定期归档历史数据

---

### 3.9 系统配置表（settings）

```sql
CREATE TABLE `settings` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `key` VARCHAR(100) NOT NULL UNIQUE COMMENT '配置键',
  `value` TEXT DEFAULT NULL COMMENT '配置值',
  `description` VARCHAR(255) DEFAULT NULL COMMENT '配置说明',
  `type` ENUM('string', 'number', 'boolean', 'json') DEFAULT 'string' COMMENT '值类型',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_key` (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

**用途**：
- 存储网站标题、描述、关键词等 SEO 信息
- 存储网站公告、维护模式开关等
- 存储第三方服务配置（邮件、对象存储等）

---

## 4. 表关系总结

### 4.1 一对多关系
- `users` ← `articles`（一个用户可发布多篇文章）
- `users` ← `comments`（一个用户可发表多条评论）
- `categories` ← `articles`（一个分类包含多篇文章）
- `articles` ← `comments`（一篇文章可有多条评论）
- `comments` ← `comments`（一条评论可有多条回复）

### 4.2 多对多关系
- `articles` ↔ `tags`（通过 `article_tags` 中间表）

### 4.3 自关联关系
- `categories.parent_id` → `categories.id`（多级分类）
- `comments.parent_id` → `comments.id`（多级回复）

---

## 5. 索引策略

### 5.1 主键索引
所有表的 `id` 字段自动创建主键索引

### 5.2 唯一索引
- `users.username`, `users.email`
- `categories.slug`, `tags.slug`, `articles.slug`
- `article_tags(article_id, tag_id)` 联合唯一索引
- `likes(user_id, target_type, target_id)` 联合唯一索引

### 5.3 普通索引
- **查询优化**：`articles.published_at`, `comments.created_at`
- **外键索引**：`articles.author_id`, `articles.category_id`
- **状态筛选**：`articles.status`, `users.role`
- **排序优化**：`categories.sort_order`

### 5.4 全文索引
- `articles(title, content)` - 用于文章搜索

### 5.5 联合索引
- `articles(is_top, published_at)` - 置顶文章列表查询
- `comments(article_id, created_at)` - 文章评论列表查询

---

## 6. 性能优化建议

### 6.1 查询优化
1. **冗余字段**：
   - `categories.article_count`, `tags.article_count`
   - `articles.comment_count`, `articles.view_count`
   - 减少 COUNT 查询，异步更新统计数据

2. **分页查询**：
   - 文章列表：`LIMIT + OFFSET` 或游标分页
   - 评论列表：分页加载，避免一次性查询所有评论

3. **避免 N+1 查询**：
   - 使用 `JOIN` 或 ORM 的 `include/eager loading`
   - 示例：查询文章列表时，一次性加载作者和分类信息

### 6.2 缓存策略
使用 **Redis** 缓存以下数据：

```redis
# 热门文章（按浏览量排序）
hot_articles: ZSET (score: view_count, member: article_id)

# 最新文章
latest_articles: LIST (article_id)

# 分类列表
categories: HASH (key: category_id, value: JSON)

# 标签云
tags_cloud: ZSET (score: article_count, member: tag_name)

# 文章详情（缓存 1 小时）
article:123: HASH (文章完整信息)

# 文章阅读计数（定时同步到 MySQL）
article:123:views: STRING (increment)

# 用户 Session
session:user_id: HASH (用户会话信息)
```

### 6.3 数据归档
- **浏览历史**：超过 90 天的数据归档到历史表
- **评论**：软删除机制（`deleted_at` 字段）

---

## 7. 数据示例

### 7.1 分类数据示例

```sql
INSERT INTO categories (name, slug, description, parent_id, sort_order) VALUES
('技术', 'tech', '技术相关文章', NULL, 1),
('前端', 'frontend', '前端开发', 1, 1),
('后端', 'backend', '后端开发', 1, 2),
('生活', 'life', '生活随笔', NULL, 2),
('读书', 'reading', '读书笔记', NULL, 3);
```

### 7.2 标签数据示例

```sql
INSERT INTO tags (name, slug, color) VALUES
('React', 'react', '#61DAFB'),
('Vue', 'vue', '#4FC08D'),
('Node.js', 'nodejs', '#339933'),
('JavaScript', 'javascript', '#F7DF1E'),
('TypeScript', 'typescript', '#3178C6');
```

---

## 8. 数据库迁移策略

### 8.1 使用 ORM 迁移工具
- **TypeORM**：`typeorm migration:create`
- **Sequelize**：`sequelize-cli migration:create`
- **Prisma**：`prisma migrate dev`

### 8.2 版本控制
```
migrations/
├── 001_create_users_table.sql
├── 002_create_categories_table.sql
├── 003_create_tags_table.sql
├── 004_create_articles_table.sql
└── 005_create_comments_table.sql
```

---

## 9. 安全注意事项

1. **SQL 注入防护**：使用参数化查询（ORM 自动处理）
2. **密码存储**：bcrypt 加密，不可逆
3. **敏感信息**：`password` 字段查询时排除返回
4. **软删除**：重要数据（文章、用户）支持软删除
5. **备份策略**：每日自动备份，保留 30 天

---

## 10. 后续优化方向

1. **读写分离**：主库写、从库读（MySQL 主从复制）
2. **分库分表**：当文章表超过 1000 万条时考虑分表
3. **ElasticSearch**：引入全文搜索引擎，提升搜索体验
4. **MongoDB**：存储文章草稿和历史版本（非结构化数据）
5. **图数据库**：用户关注关系、文章推荐图谱（可选）

---

## 11. 数据库初始化脚本

完整的建表脚本已保存在：
- `database/schema.sql` - 表结构定义
- `database/seed.sql` - 初始数据填充
- `database/indexes.sql` - 索引优化脚本

执行顺序：
```bash
mysql -u root -p blog_db < database/schema.sql
mysql -u root -p blog_db < database/seed.sql
mysql -u root -p blog_db < database/indexes.sql
```
